name: Publish Packages

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual publish)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: 'https://npm.pkg.github.com'
          scope: '@omnifex'

      - name: Enable Corepack
        run: corepack enable

      - name: Activate pnpm
        run: corepack prepare pnpm@10.26.2 --activate

      - name: Get pnpm store path
        id: pnpm-store
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> "$GITHUB_OUTPUT"

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all publishable packages
        run: |
          pnpm nx run-many -t build -p \
            @omnifex/identity \
            @omnifex/styles \
            @omnifex/ui-components \
            @omnifex/identity-angular \
            @omnifex/identity-react \
            @omnifex/styles-angular \
            @omnifex/styles-react

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Release Pull Request or Publish (Dry Run)
        if: ${{ inputs.dry_run }}
        run: |
          echo "DRY RUN MODE - No packages will be published"
          pnpm changeset version
          pnpm changeset publish --dry-run
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Version and Publish Packages
        if: ${{ !inputs.dry_run }}
        run: |
          # Version packages based on changesets
          pnpm changeset version
          
          # Commit version changes
          git add .
          git commit -m "chore: version packages" || echo "No version changes to commit"
          git push
          
          # Publish packages to GitHub Packages
          pnpm changeset publish --tag latest
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Releases
        if: ${{ !inputs.dry_run }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Get all published packages
            const packages = [
              { name: '@omnifex/identity', path: 'libs/identity' },
              { name: '@omnifex/styles', path: 'libs/styles' },
              { name: '@omnifex/ui-components', path: 'libs/ui-components' },
              { name: '@omnifex/identity-angular', path: 'libs/identity-angular' },
              { name: '@omnifex/identity-react', path: 'libs/identity-react' },
              { name: '@omnifex/styles-angular', path: 'libs/styles-angular' },
              { name: '@omnifex/styles-react', path: 'libs/styles-react' }
            ];
            
            for (const pkg of packages) {
              try {
                const packageJsonPath = path.join(process.cwd(), pkg.path, 'package.json');
                const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
                const version = packageJson.version;
                const tagName = `${pkg.name}@${version}`;
                
                // Check if tag already exists
                try {
                  await github.rest.git.getRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: `tags/${tagName}`
                  });
                  console.log(`Tag ${tagName} already exists, skipping release creation`);
                  continue;
                } catch (error) {
                  if (error.status !== 404) throw error;
                }
                
                // Create release
                await github.rest.repos.createRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag_name: tagName,
                  name: `${pkg.name} v${version}`,
                  body: `Release ${pkg.name} version ${version}\n\nView on GitHub Packages: https://github.com/${context.repo.owner}/${context.repo.repo}/packages`,
                  draft: false,
                  prerelease: version.includes('-')
                });
                
                console.log(`Created release for ${tagName}`);
              } catch (error) {
                console.error(`Failed to create release for ${pkg.name}:`, error);
              }
            }